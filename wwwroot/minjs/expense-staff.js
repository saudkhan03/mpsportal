var expensemodule=angular.module("app-mps",["ngConfirm"]);expensemodule.controller("staff-expense",["$scope","$http",function(l,r){var a=(e=new Date).getDate(),t=e.getMonth()+1;a<10&&(a="0"+a),t<10&&(t="0"+t);var e=a+"-"+t+"-"+e.getFullYear();l.salary={Date:e,newSalaryDate:e};var i=[];l.wait=!0,r.get("/Expense/LoadStaff").then(function(a){i=a.data.staff,l.StaffList=i;var n=[];$.each(a.data.deductions,function(a,t){var e={index:a,name:t.name,value:t.value,type:t.type,display:t.value+("A"==t.type?" Rs.":t.type)};n.push(e)}),l.deductions=n,l.newEmail="",l.wait=!1},function(a){alert(a.statusText),l.wait=!1}),l.changed=function(){l.StaffList=l.searchtext?performfilter(l.searchtext):i},performfilter=function(a){return filterby=a.toLocaleLowerCase(),i.filter(function(a){return-1!=a.name.toLocaleLowerCase().indexOf(filterby)})},l.salaryChange=function(){var a=l.deductions,n=l.salary.txtSalary,r=[];$.each($('[id^="chkd_"]'),function(a,t){$(this).is(":checked")&&r.push(t.id.split("_")[1])});var i=0,s=[];$.each(a,function(a,t){var e=t.value;if(-1<$.inArray(t.index.toString(),r))switch(t.type){case"%":-1<t.name.indexOf("Provident fund")?0<i?(t.display="  "+i+" - ("+e+t.type+" of "+n+") = "+(i-Number(e)%i).toString(),i=(i-Number(e)%i).toString()):(t.display="  "+n+" - ("+e+t.type+" of "+n+") = "+(n-Number(e)%n).toString(),i=(n-Number(e)%n).toString()):-1<t.name.indexOf("Provident fund")?t.display=e+t.type:-1==t.name.indexOf("Provident fund")&&(0<i?(t.display="  "+i+" - ("+e+t.type+" of "+n+") = "+(i-Number(e)%i).toString(),i=(i-Number(e)%i).toString()):(t.display="  "+n+" - ("+e+t.type+" of "+n+") = "+(n-Number(e)%n).toString(),i=(n-Number(e)%n).toString())),s.push(t);break;case"A":case"Rs":0<i?(t.display=" "+i+" - Rs. "+e+" = "+(i-Number(e)).toString(),i=(i-Number(e)).toString()):(t.display=" "+n+" - Rs. "+e+" = "+(n-Number(e)).toString(),i=(n-Number(e)).toString()),s.push(t)}else t.display=t.value+t.type,s.push(t)}),l.deductions=s,l.salary.newSalaryAmount=i},l.getStaff=function(a){l.wait=!0,l.student=r.get("/Expense/getStaff",{params:{id:a}}).then(function(a){l.staff=a.data,l.wait=!1},function(a){l.wait=!1,alert("ERROR while getting staff")}),$("#addsalary").hide(),$("#btnaddsalary").show()},l.getSalary=function(a){l.salaryWait=!0,r.get("/Expense/getSalary",{params:{staffId:a}}).then(function(a){l.staff.salaryPayments=a.data.salaryPayments,l.salaryWait=!1},function(a){alert(a.statusText),l.salaryWait=!1})},l.addSalary=function(){l.wait=!0,l.salary.staffId=l.staff.staffId,r.post("/Expense/addSalary",l.salary).then(function(a){if("object"==typeof a){$("#addsalary").toggle(),$("#btnaddsalary").toggle();var t=a.data;l.staff.salaryPayments.push(t),l.wait=!1}else l.wait=!1,alert(a)},function(a){l.wait=!1,alert(a.statusText)})},l.deleteSalary=function(e){r.post("/Expense/deleteSalary",e).then(function(){$.each(l.staff.salaryPayments,function(a,t){if(t.id===e)return l.staff.salaryPayments.splice(a,1),!1})},function(a){alert(a.statusText)})},l.cancelAddSalaryForm=function(){$("#addsalary").toggle(),$("#btnUpdateSalary").toggle(),$("#btnaddsalary").toggle(),l.salary.Amount=""},l.cancelUpdateSalaryForm=function(){$("#updateSalary").toggle(),$("#btnaddsalary").toggle(),$("#btnUpdateSalary").toggle(),l.salary.newSalaryAmount=""},l.updateSalary=function(){l.wait=!0,l.salary.staffId=l.staff.staffId;var e="",n=[];$.each($('[id^="chkd_"]'),function(a,t){$(this).is(":checked")&&n.push(t.id.split("_")[1])}),$.each(l.deductions,function(a,t){-1<$.inArray(t.index.toString(),n)&&(e=0<e.length?e+"~"+t.name+": "+t.value+t.type:e+t.name+": "+t.value+t.type)}),l.salary.deductionString=e,r.post("/Expense/updateSalary",l.salary).then(function(a){if("object"==typeof a){$("#updateSalary").toggle(),$("#btnUpdateSalary").toggle(),$("#btnaddsalary").toggle();a.data;l.staff.totalSalary=a.data.salary;var t=(t=a.data.salarySetDate).split("-")[2]+"-"+t.split("-")[1]+"-"+t.split("-")[0];l.staff.salarySetDate=t,l.wait=!1}else l.wait=!1,alert(a)},function(a){l.wait=!1,alert(a.statusText)})},l.sendSalaryDetails=function(a){l.wait=!0;var t=0==$("#newEmail").val().length?l.staff.email:$("#newEmail").val();r.get("/Expense/sendSalaryEmail?staffId="+l.staff.staffId+"&email="+t+"&paymentId="+a).then(function(a){a.data?alert("Mail sent"):alert("Could not send email,\nplease check your internet connection\nand try again"),l.wait=!1},function(a){l.wait=!1,alert(a.statusText)})},l.getActiveClass=function(a){return"True"==a?"fa fa-circle-o activeUser":"fa fa-circle-o inactiveUser"}}]);