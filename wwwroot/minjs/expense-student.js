var expensemodule=angular.module("app-mps",["ngConfirm"]);expensemodule.controller("student-edit",["$scope","$http",function(r,d){r.fees={Date:(new Date).toDateString()};var n=[];r.wait=!0,d.get("/Expense/LoadStudents").then(function(e){var t=s(e.data.students);n=t,r.StudentList=n,r.wait=!1},function(e){alert(e.statusText),r.wait=!1});var s=function(e){var a=[],n="",s=1;return $.each(e,function(e,t){n!=t.studentId?(n=t.studentId,a.push(t)):(i(a[e-s].studentName.split("-")[3],t.studentName.split("-")[3])||(a.splice(e-s,1),a.push(t)),s++)}),a},i=function(e,t){return e="LKG"==e?-1:"UKG"==e?0:e.split(" ")[0],t="LKG"==t?-1:"UKG"==t?0:t.split(" ")[0],Number(e)>Number(t)};r.changed=function(){r.StudentList=r.searchtext?performfilter(r.searchtext):n},performfilter=function(e){return filterby=e.toLocaleLowerCase(),n.filter(function(e){return-1!=e.studentName.split("-").splice(1,3).join("").toLocaleLowerCase().indexOf(filterby)})},r.getStudent=function(e){r.wait=!0;var t=(n=new Date).getDate(),a=n.getMonth()+1;t<10&&(t="0"+t),a<10&&(a="0"+a);var n=t+"-"+a+"-"+n.getFullYear();r.fees.Date=n,r.student=d.get("/Expense/getStudent",{params:{id:e}}).then(function(a){r.student=a.data;var n="",s=[];$.each(r.student.feeDates,function(e,t){n!=t.academicYear&&(n=t.academicYear,s.push(t))}),r.student.feeDates=s,$.each(r.student.feeDates,function(e,t){t.academicYear==a.data.academicYear&&(r.ayselected=t)}),r.ayselected||(d.get("/Expense/getSlabsAndGrades",{params:{id:e}}).then(function(e){r.slabs=e.data.slabs,r.grades=e.data.grades;var t=new Object;t.slabName=r.student.slabName,t.grade=r.student.grade,t.totalFee=0,r.acadSlab=t,r.acadSlab.totalFee=r.getAYFees()},function(e){r.slabs=null,alert("Could not load the list of slabs, please try again by refeshing this page")}),r.student.totalFee=0);var i=0;$.each(r.student.fees,function(e,t){i+=t.paidFees}),r.totalPaidFees=i,r.totalFeeWithExpense=r.student.totalFee,r.student.expenses&&0<r.student.expenses.length&&$.each(r.student.expenses,function(e,t){r.totalFeeWithExpense=r.totalFeeWithExpense+t.amount}),$("#addfee").hide(),$("#btnaddfee").show(),$("#btnaddfeedates").show(),r.wait=!1},function(e){r.wait=!1,alert(e.statusText)})},r.getFees=function(e,t){if(!e)return!1;r.feesWait=!0,d.get("/Expense/getFees",{params:{studentId:e,academicYear:t}}).then(function(e){r.student.fees=e.data.fees,r.student.expenses=e.data.expenses;var a=0;$.each(r.student.fees,function(e,t){a+=t.paidFees}),r.totalPaidFees=a,r.student.totalFee=e.data.totalFee,r.feesWait=!1},function(e){alert(e.statusText),r.feesWait=!1})},r.getAYFees=function(){if(r.acadSlab.grade&&r.acadSlab.slabName)return d.get("/Admin/getFee",{params:{slabName:r.acadSlab.slabName,grade:r.acadSlab.grade}}).then(function(e){$("#txtAYFee").val(e.data)},function(e){alert(e.statusText)}),0},r.addAcademicYear=function(){r.wait=!0;var e=new Object;e.StudentId=r.student.studentId,e.slabName=r.acadSlab.slabName,e.grade=r.acadSlab.grade,d.post("/Expense/addAcademicYear",e).then(function(e){""==e.data.exep?(r.wait=!1,window.location.reload()):(r.wait=!1,alert(e.data.exep))},function(e){r.wait=!1,alert(e.statusText)})},r.addFees=function(e){r.wait=!0,r.fees.Id=e,d.post("/Expense/addFee",r.fees).then(function(e){$("#addfee").toggle(),$("#btnaddfee").toggle();var t=e.data;r.student.fees.push(t);var a=0;$.each(r.student.fees,function(e,t){a+=t.paidFees}),r.totalPaidFees=a,r.wait=!1},function(e){r.wait=!1,aler(error.statusText)})},r.deleteFee=function(t){r.wait=!1,d.post("/Expense/deleteFee",t).then(function(){$.each(r.student.fees,function(e){if(r.student.fees[e].id===t)return r.student.fees.splice(e,1),!1});var a=0;$.each(r.student.fees,function(e,t){a+=t.paidFees}),r.totalPaidFees=a,r.wait=!1},function(e){r.wait=!1,alert(e.statusText)})},r.printBill=function(e,t,a,n){var s=(d=new Date).getDate(),i=d.getMonth()+1;s<10&&(s="0"+s),i<10&&(i="0"+i);var d=s+"-"+i+"-"+d.getFullYear(),u="";u=n.middleName?n.firstName+" "+n.middleName+" "+n.lastName:n.lastName?n.firstName+" "+n.lastName:n.firstName;var l={generatedFor:"",paidFees:t,paidDate:a,today:d,rollNo:n.rollNumber,grade:n.grade,name:u,admissionFee:0,cautionDeposit:0,tutionFee:0,hostelExpenses:0,others:0,total:0,paymentType:"Cash",paymentId:e};r.printModal=l,$(".btn-group button").each(function(e,t){"btnPrintBillCash"==$(t).attr("id")?($(t).removeClass("btn-default"),$(t).addClass("btn-info")):($(t).addClass("btn-default"),$(t).removeClass("btn-info"))});var o=r.printModal;r.printModal.total=Number(o.admissionFee)+Number(o.cautionDeposit)+Number(o.tutionFee)+Number(o.hostelExpenses)+Number(o.others),$("#printBillModal").modal()},r.cancelAddFeeForm=function(){var e=(a=new Date).getDate(),t=a.getMonth()+1;e<10&&(e="0"+e),t<10&&(t="0"+t);var a=e+"-"+t+"-"+a.getFullYear();$("#addfee").toggle(),$("#btnaddfee").toggle(),r.fees.Amount="",r.fees.Date=a},r.getPrintModalClass=function(){var e=r.printModal;if(e)return e.total=Number(e.admissionFee)+Number(e.cautionDeposit)+Number(e.tutionFee)+Number(e.hostelExpenses)+Number(e.others),e.total!=e.paidFees?"printStudentBillRed":"printStudentBillBlue"},r.print=function(){r.wait=!0,r.printModal.generatedFor=r.student.studentId,d.post("/Expense/printBill",r.printModal).then(function(e){r.wait=!1,e.data.res?(r.getFees(r.student.studentId,r.ayselected.academicYear),window.open(window.location.href.split("/")[0]+"/Bills/"+e.data.file,"_blank")):alert(e.data.status+" "+e.data.errors)},function(e){r.wait=!1,alert(e.statusText)})},r.showBill=function(e){r.wait=!0,d.post("/Expense/getBill",e).then(function(e){r.wait=!1,e.data.res?window.open(window.location.href.split("/")[0]+"/Bills/"+e.data.file,"_blank"):alert(e.data.status+" "+e.data.err)},function(e){r.wait=!1,alert(e.statusText)})},r.getActiveClass=function(e){return"True"==e?"fa fa-circle-o activeUser":"fa fa-circle-o inactiveUser"},r.changeListActive=function(){var a=!1;$.each(r.StudentFullList,function(e,t){-1<t.studentName.indexOf("False")&&(a=!0)}),r.wait=!0,a?(n=[],$("#chkActive").is(":checked")?($.each(r.StudentList,function(e,t){-1==t.studentName.indexOf("False")&&n.push(t)}),r.StudentList=n):(r.StudentList=r.StudentFullList,n=r.StudentFullList),r.wait=!1):d.get("/Admin/getStudentList?activeOnly="+$("#chkActive").is(":checked")).then(function(e){n=[];var t=s(e.data);r.StudentFullList=t,r.StudentList=r.StudentFullList,n=r.StudentFullList,r.wait=!1},function(e){alert(e.statusText),r.wait=!1})}}]);